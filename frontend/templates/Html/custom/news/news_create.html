{% comment %} @SPK@include("partials/mainhead.html") {% endcomment %}
{% include "../../partials/mainhead.html" %}

<link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />

<style>
    .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
    }
    .drop-zone.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .image-preview {
        position: relative;
        display: block;
        cursor: move;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: #fff;
        border-radius: 6px;
        overflow: hidden;
    }
    .image-preview img {
        width: 100%;
        height: auto;
        display: block;
    }
    .resize-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #007bff;
        border: 1px solid #fff;
        bottom: -5px;
        right: -5px;
        cursor: se-resize;
        border-radius: 50%;
    }
    .quill-editor-container {
        height: 300px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        background-color: white;
    }
    .quill-editor-container .ql-editor {
        min-height: 250px;
        max-height: 250px;
        overflow-y: auto;
    }
    .ql-toolbar {
        border-radius: 6px 6px 0 0;
    }
    @media (max-width: 576px) {
        .image-preview-container {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>

{% include "../../partials/switcher.html" %}
<div class="page">
    {% include "../../partials/header.html" %}
    {% include "../../partials/sidebar.html" %}

    <div class="main-content app-content">
        <div class="container mt-5">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4>Create News</h4>
                </div>
                <div class="card-body">
                    <form id="newsForm">
                        <div class="mb-3">
                            <label class="form-label">Category</label>

                            <div class="input-group">
                                <select id="categorySelect" class="form-select" required>
                                    <option value="">Select category</option>
                                </select>

                                <button type="button"
                                        class="btn btn-outline-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#addCategoryModal">
                                    +
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" placeholder="Enter news title" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <div id="toolbar-container"></div>
                            <div id="quill-editor" class="quill-editor-container"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Upload Images</label>
                            <div id="dropZone" class="drop-zone">
                                <p>Drag and drop images here, or click to browse.</p>
                                <input type="file" id="images" multiple accept="image/*" class="d-none">
                            </div>
                            <div id="image-preview-container" class="image-preview-container"></div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sendNotification">
                            <label class="form-check-label" for="sendNotification">
                                Send notification to all users about this news
                            </label>
                        </div>

                        <div class="d-flex align-items-center">
                            <button type="submit" class="btn btn-success me-3" id="submitButton">Create News</button>
                            
                            <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div id="responseMessage" class="mt-3"></div>
        </div>
    </div>
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name</label>
                        <input type="text" id="newCategoryName" class="form-control">
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="createCategoryBtn">
                        Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% include "../../partials/headersearch_modal.html" %}
    {% include "../../partials/footer.html" %}
</div>

{% include "../../partials/commonjs.html" %}
{% include "../../partials/custom_switcherjs.html" %}

<script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    /** ---------- Initialize Quill ---------- **/


    const categorySelect = document.getElementById("categorySelect");

    async function loadCategories(selectedId = null) {
        try {
            const res = await axios.get("/api/news-categories/");
            categorySelect.innerHTML = '<option value="">Select category</option>';

            res.data.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.textContent = cat.name;
                if (selectedId && selectedId == cat.id) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
        } catch (err) {
            console.error("Failed to load categories", err);
        }
    }

    // Load categories on page load
    loadCategories();


    const createCategoryBtn = document.getElementById("createCategoryBtn");

    createCategoryBtn.addEventListener("click", async () => {
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) return alert("Category name required");

        try {
            const token = localStorage.getItem("access_token");
            const headers = token ? { Authorization: `Bearer ${token}` } : {};

            const res = await axios.post(
                "/api/news-categories/",
                { name },
                { headers }
            );

            // Reload categories and auto-select new one
            await loadCategories(res.data.id);

            document.getElementById("newCategoryName").value = "";

            bootstrap.Modal.getInstance(
                document.getElementById("addCategoryModal")
            ).hide();
        } catch (err) {
            console.error("Category create failed", err);
            alert("Failed to create category");
        }
    });


    const toolbarOptions = [
        [{ 'font': [] }, { 'size': [] }],
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        [{ 'indent': '-1' }, { 'indent': '+1' }],
        [{ 'align': [] }],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'image', 'video'],
        ['table'],
        ['clean']
    ];

    const quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: { container: toolbarOptions },
            table: true
        }
    });

    /** ---------- Image Upload Preview ---------- **/
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('images');
    const previewContainer = document.getElementById('image-preview-container');
    let uploadedFiles = [];

    dropZone.addEventListener('click', () => imageInput.click());
    ['dragover', 'drop'].forEach(event => {
        dropZone.addEventListener(event, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

    dropZone.addEventListener('drop', e => {
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFiles(files);
    });

    imageInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
        for (const file of files) {
            if (file.type.startsWith('image/')) {
                uploadedFiles.push(file);
                const reader = new FileReader();
                reader.onload = e => createImagePreview(e.target.result, file);
                reader.readAsDataURL(file);
            }
        }
    }

    function createImagePreview(imageData, file) {
        const previewDiv = document.createElement('div');
        previewDiv.classList.add('image-preview');
        previewDiv.dataset.filename = file.name;

        const img = document.createElement('img');
        img.src = imageData;
        img.draggable = true;

        const resizeHandle = document.createElement('div');
        resizeHandle.classList.add('resize-handle');

        previewDiv.appendChild(img);
        previewDiv.appendChild(resizeHandle);
        previewContainer.appendChild(previewDiv);

        addResizeListener(img, resizeHandle);
    }

    function addResizeListener(img, handle) {
        let isResizing = false;
        let startX, startWidth;

        handle.addEventListener('mousedown', e => {
            e.preventDefault();
            isResizing = true;
            startX = e.clientX;
            startWidth = img.offsetWidth;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            if (!isResizing) return;
            const newWidth = startWidth + (e.clientX - startX);
            img.style.width = `${newWidth}px`;
            img.style.height = 'auto';
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
    }

    /** ---------- Submit Form ---------- **/
    const form = document.getElementById('newsForm');
    const responseMessage = document.getElementById('responseMessage');
    const sendNotificationCheckbox = document.getElementById('sendNotification');
    
    // üöÄ NEW: Get the button and spinner elements
    const submitButton = document.getElementById('submitButton');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // üöÄ Helper functions to manage UI state
    function setLoading(isLoading) {
        submitButton.disabled = isLoading;
        if (isLoading) {
            loadingSpinner.style.display = 'inline-block';
            submitButton.textContent = 'Processing...'; 
        } else {
            loadingSpinner.style.display = 'none';
            submitButton.textContent = 'Create News'; 
        }
    }


    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 1. SHOW LOADER / DISABLE BUTTON
        setLoading(true);

        // Build FormData
        const formData = new FormData();
        formData.append('title', document.getElementById('title').value.trim());
        formData.append('content', quill.root.innerHTML);

        // Append images (same field name repeated for multiple files)
        for (const file of uploadedFiles) {
            formData.append('uploaded_images', file);
        }
        const categoryId = categorySelect.value;
        if (categoryId) {
            formData.append("category_id", categoryId);
        }
        // Append checkbox value explicitly
        const sendNotification = !!sendNotificationCheckbox.checked;
        formData.append('send_notification', sendNotification ? 'true' : 'false');


        try {
            const token = localStorage.getItem('access_token');
            const headers = {};
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const res = await axios.post('/api/news/', formData, { headers });

            responseMessage.innerHTML = `<div class="alert alert-success">‚úÖ News created successfully!</div>`;
            form.reset();
            quill.root.innerHTML = '';
            uploadedFiles = [];
            previewContainer.innerHTML = '';
        } catch (error) {
            console.error('Create news error:', error);
            // Show server error message if available
            let msg = '‚ùå Failed to create news';
            if (error.response && error.response.data) {
                try {
                    const data = error.response.data;
                    if (typeof data === 'string') msg = data;
                    else if (data.detail) msg = data.detail;
                    else if (data.non_field_errors) msg = data.non_field_errors.join(' ');
                    else msg = JSON.stringify(data);
                } catch (e) {
                    // ignore parsing errors
                }
            }
            responseMessage.innerHTML = `<div class="alert alert-danger">${msg}</div>`;
        } finally {
            // 2. HIDE LOADER / RE-ENABLE BUTTON on success or error
            setLoading(false);
        }
    });
});
</script>


</body>
</html>