{% comment %} @SPK@include("partials/mainhead.html") {% endcomment %}
{% include "../../partials/mainhead.html" %}

<!-- ✅ Quill v2 (includes native table support) -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />

<style>
  .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.3s;
  }
  .drop-zone.dragover {
      border-color: #007bff;
      background-color: #f8f9fa;
  }
  .image-preview-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
  }
  .image-preview {
      position: relative;
      display: block;
      cursor: move;
      border: 1px solid #ddd;
      padding: 5px;
      background-color: #fff;
      border-radius: 6px;
      overflow: hidden;
  }
  .image-preview img {
      width: 100%;
      height: auto;
      display: block;
  }
  .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #007bff;
      border: 1px solid #fff;
      bottom: -5px;
      right: -5px;
      cursor: se-resize;
      border-radius: 50%;
  }
  .quill-editor-container {
      height: 300px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      background-color: white;
  }
  .quill-editor-container .ql-editor {
      min-height: 250px;
      max-height: 250px;
      overflow-y: auto;
  }
  .ql-toolbar {
      border-radius: 6px 6px 0 0;
  }
  @media (max-width: 576px) {
      .image-preview-container {
          grid-template-columns: 1fr;
      }
  }
</style>
</head>

{% include "../../partials/switcher.html" %}
<div class="page">
  {% include "../../partials/header.html" %}
  {% include "../../partials/sidebar.html" %}

  <div class="main-content app-content">
    <div class="container mt-5">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
          <h4>Create News</h4>
        </div>
        <div class="card-body">
          <form id="newsForm">
            <div class="mb-3">
              <label for="title" class="form-label">Title</label>
              <input type="text" class="form-control" id="title" placeholder="Enter news title" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Content</label>
              <div id="toolbar-container"></div>
              <div id="quill-editor" class="quill-editor-container"></div>
            </div>

            <div class="mb-3">
              <label class="form-label">Upload Images</label>
              <div id="dropZone" class="drop-zone">
                <p>Drag and drop images here, or click to browse.</p>
                <input type="file" id="images" multiple accept="image/*" class="d-none">
              </div>
              <div id="image-preview-container" class="image-preview-container"></div>
            </div>

            <button type="submit" class="btn btn-success">Create News</button>
          </form>
        </div>
      </div>
      <div id="responseMessage" class="mt-3"></div>
    </div>
  </div>

  {% include "../../partials/headersearch_modal.html" %}
  {% include "../../partials/footer.html" %}
</div>

{% include "../../partials/commonjs.html" %}
{% include "../../partials/custom_switcherjs.html" %}

<!-- ✅ JS Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    /** ---------- Initialize Quill ---------- **/
    const toolbarOptions = [
        [{ 'font': [] }, { 'size': [] }],
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        [{ 'indent': '-1' }, { 'indent': '+1' }],
        [{ 'align': [] }],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'image', 'video'],
        ['table'],
        ['clean']
    ];

    const quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
            toolbar: { container: toolbarOptions },
            table: true
        }
    });

    /** ---------- Image Upload Preview ---------- **/
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('images');
    const previewContainer = document.getElementById('image-preview-container');
    let uploadedFiles = [];

    dropZone.addEventListener('click', () => imageInput.click());
    ['dragover', 'drop'].forEach(event => {
        dropZone.addEventListener(event, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

    dropZone.addEventListener('drop', e => {
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) handleFiles(files);
    });

    imageInput.addEventListener('change', e => handleFiles(e.target.files));

    function handleFiles(files) {
        for (const file of files) {
            if (file.type.startsWith('image/')) {
                uploadedFiles.push(file);
                const reader = new FileReader();
                reader.onload = e => createImagePreview(e.target.result, file);
                reader.readAsDataURL(file);
            }
        }
    }

    function createImagePreview(imageData, file) {
        const previewDiv = document.createElement('div');
        previewDiv.classList.add('image-preview');
        previewDiv.dataset.filename = file.name;

        const img = document.createElement('img');
        img.src = imageData;
        img.draggable = true;

        const resizeHandle = document.createElement('div');
        resizeHandle.classList.add('resize-handle');

        previewDiv.appendChild(img);
        previewDiv.appendChild(resizeHandle);
        previewContainer.appendChild(previewDiv);

        addResizeListener(img, resizeHandle);
    }

    function addResizeListener(img, handle) {
        let isResizing = false;
        let startX, startWidth;

        handle.addEventListener('mousedown', e => {
            e.preventDefault();
            isResizing = true;
            startX = e.clientX;
            startWidth = img.offsetWidth;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            if (!isResizing) return;
            const newWidth = startWidth + (e.clientX - startX);
            img.style.width = `${newWidth}px`;
            img.style.height = 'auto';
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
    }

    /** ---------- Submit Form ---------- **/
    const form = document.getElementById('newsForm');
    const responseMessage = document.getElementById('responseMessage');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData();
        formData.append('title', document.getElementById('title').value);
        formData.append('content', quill.root.innerHTML);

        for (const file of uploadedFiles) {
            formData.append('uploaded_images', file);
        }

        try {
            const token = localStorage.getItem('access_token');
            const res = await axios.post('/api/news/', formData, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            responseMessage.innerHTML = `<div class="alert alert-success">✅ News created successfully!</div>`;
            form.reset();
            quill.root.innerHTML = '';
            uploadedFiles = [];
            previewContainer.innerHTML = '';
        } catch (error) {
            console.error(error);
            responseMessage.innerHTML = `<div class="alert alert-danger">❌ Failed to create news</div>`;
        }
    });
});
</script>

</body>
</html>
