{% comment %} @SPK@include("partials/mainhead.html") {% endcomment %}
{% include "../../partials/mainhead.html"%}

</head>

{% include "../../partials/switcher.html" %}
<div class="page">
    {% include "../../partials/header.html"%}
    {% include "../../partials/sidebar.html" %}

      <div class="main-content app-content">
          <div class="container py-5">
              <h2 class="mb-4">ðŸ“Š Segment Users by Query</h2>

              <form id="query-form" class="mb-4">
                  <div class="mb-3">
                      <label for="query" class="form-label">Enter Query</label>
                      <textarea class="form-control" id="query" rows="4" placeholder="SELECT user FROM notifications_useractivity WHERE path != '/quiz/' AND timestamp >= NOW() - INTERVAL '30 days'"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary" id="run-query-btn">
                      Run Query
                      <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" id="query-spinner" style="display: none;"></span>
                  </button>
              </form>

              <div id="query-results" class="mb-5" style="display:none;">
                  <h4>ðŸŽ¯ Matched Users</h4>
                  <div class="table-responsive">
                      <table class="table table-bordered table-striped">
                          <thead class="table-dark">
                              <tr>
                                  <th>#</th>
                                  <th>User</th>
                                  <th>Device ID</th>
                                  <th>FCM Token</th>
                              </tr>
                          </thead>
                          <tbody id="results-body"></tbody>
                      </table>
                  </div>
                  <p id="user-count" class="fw-bold"></p>
              </div>

              <div class="notification-panel" style="display:none;">
                  <h2 class="mb-4">ðŸ“£ Send Notification</h2>
                  <form id="notification-form">
                      <div class="mb-3">
                          <label for="title" class="form-label">Title</label>
                          <input type="text" class="form-control" id="title" placeholder="Notification title" required>
                      </div>
                      <div class="mb-3">
                          <label for="body" class="form-label">Body</label>
                          <textarea class="form-control" id="body" rows="3" placeholder="Notification message" required></textarea>
                      </div>
                      <div class="mb-3">
                          <label for="url" class="form-label">Click Action URL (optional)</label>
                          <input type="url" class="form-control" id="url" placeholder="https://yourdomain.com/target-page">
                      </div>

                      <div class="mb-3">
                          <label for="image" class="form-label">Image URL (optional)</label>
                          <input type="url" class="form-control" id="image" placeholder="https://example.com/image.jpg">
                      </div>
                      <button type="submit" class="btn btn-success" id="send-notification-btn">
                          Send Notification
                          <span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" id="notification-spinner" style="display: none;"></span>
                      </button>
                  </form>
                  <div id="notification-status" class="mt-3 text-success fw-bold"></div>
              </div>
          </div>
      </div>
    </div>
    {% include "../../partials/headersearch_modal.html"%}
    {% include "../../partials/footer.html" %}
</div>

{% include "../../partials/commonjs.html"%}
{% include "../../partials/custom_switcherjs.html"%}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script src="../../../../static/assets/js/custom.js"></script>

<script>
// =================================================================
// RUN QUERY LOGIC
// =================================================================
document.getElementById('query-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const query = document.getElementById('query').value;
    const token = localStorage.getItem('access_token');
    
    // Get button and spinner references
    const runBtn = document.getElementById('run-query-btn');
    const spinner = document.getElementById('query-spinner');

    // Start Loading State
    runBtn.disabled = true;
    spinner.style.display = 'inline-block';
    document.getElementById('query-results').style.display = 'none';
    document.querySelector('.notification-panel').style.display = 'none';

    try {
        const res = await fetch('/api/segment-users/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ query })
        });

        const data = await res.json();

        if (!res.ok) {
            throw new Error(data.error || 'Unknown error');
        }

        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';

        data.users.forEach((u, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${u.user || 'Guest'}</td>
                <td>${u.device_id}</td>
                <td>${u.token}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('user-count').textContent = `Total matched users: ${data.users.length}`;
        document.getElementById('query-results').style.display = 'block';
        
        // Only show notification panel if users are found
        if (data.users.length > 0) {
            document.querySelector('.notification-panel').style.display = 'block';
        } else {
             document.querySelector('.notification-panel').style.display = 'none';
        }

        window.matchedTokens = data.users.map(u => u.token);
    } catch (err) {
        Swal.fire({
            icon: 'error',
            title: 'Query Error',
            text: err.message,
        });
    } finally {
        // Stop Loading State
        runBtn.disabled = false;
        spinner.style.display = 'none';
    }
});

// =================================================================
// SEND NOTIFICATION LOGIC (Updated with Loader)
// =================================================================
document.getElementById('notification-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('title').value;
    const body = document.getElementById('body').value;
    const image = document.getElementById('image').value;
    const url = document.getElementById('url').value;
    const token = localStorage.getItem('access_token');

    // Get button and spinner references
    const sendBtn = document.getElementById('send-notification-btn');
    const spinner = document.getElementById('notification-spinner');
    const statusDiv = document.getElementById('notification-status');
    
    // Clear previous status message
    statusDiv.textContent = ''; 

    // Start Loading State
    sendBtn.disabled = true;
    spinner.style.display = 'inline-block';

    try {
        const res = await fetch('/api/send-notification/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                title,
                body,
                image,
                url,
                tokens: window.matchedTokens
            })
        });

        const result = await res.json();

        if (!res.ok) {
            throw new Error(result.error || 'Unknown error');
        }

        Swal.fire({
            icon: 'success',
            title: 'Notification Sent',
            text: result.message || 'Successfully delivered!',
        });

        // Update status on success
        statusDiv.textContent = result.message || 'Notification sent!';
        statusDiv.className = 'mt-3 text-success fw-bold'; 

    } catch (err) {
        Swal.fire({
            icon: 'error',
            title: 'Notification Error',
            text: err.message,
        });
        
        // Update status on error
        statusDiv.textContent = `Error: ${err.message}`;
        statusDiv.className = 'mt-3 text-danger fw-bold'; 
    } finally {
        // Stop Loading State
        sendBtn.disabled = false;
        spinner.style.display = 'none';
    }
});

</script>
</body>
</html>