{% comment %} @SPK@include("partials/mainhead.html") {% endcomment %}
{% include "../../partials/mainhead.html"%}
    
    
</head>

<body>

    {% comment %} @SPK@include("partials/switcher.html") {% endcomment %}
    {% include "../../partials/switcher.html" %}
    <div class="page">
        {% comment %} @SPK@include("partials/header.html") {% endcomment %}
        {% include "../../partials/header.html"%}
        {% comment %} @SPK@include("partials/sidebar.html") {% endcomment %}
        {% include "../../partials/sidebar.html" %}
        <!-- Start::app-content -->
        <div class="main-content app-content">

            < class="container mt-5">
                
                <h5 class="mt-5 mb-3">Reward Distribution History</h5>

                
    
                    <form id="rewardDistributionForm" class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label for="distributionType" class="form-label fw-bold">Select Distribution Type</label>
                            <select id="distributionType" name="distribution_type" class="form-select" required>
                                <option value="">-- Select Type --</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="half_monthly">Half Monthly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="col-md-8 d-flex align-items-end justify-content-end">
                            <button type="submit" id="sendRewardBtn" class="btn btn-primary px-4">
                                <i class="bi bi-cash-stack me-2"></i> Send Reward
                            </button>
                        </div>
                    </form>

                    <div id="responseMessage" class="alert mt-4 d-none" role="alert"></div>

                    ---

                    <h5 class="mt-5 mb-3">üïí Distribution History</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Start Date</th>
                                    <th scope="col">End Date</th>
                                    <th scope="col">Total Users</th>
                                    <th scope="col">Total Amount (‡ß≥)</th>
                                    <th scope="col">Distributed At</th>
                                </tr>
                            </thead>
                            <tbody id="distributionList">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-3">Loading distribution history...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    


                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Type</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Total Users</th>
                                <th>Total Amount</th>
                                <th>Distributed At</th>
                            </tr>
                        </thead>
                        <tbody id="distributionList">
                            <tr><td colspan="7" class="text-center text-muted py-3">Loading distributions...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="responseMessage" class="alert mt-4 d-none"></div>
            </div>

            
        </div>
    </div>
        <!-- End::app-content -->

        {% comment %} @SPK@include("partials/headersearch_modal.html") {% endcomment %}
        {% include "../../partials/headersearch_modal.html"%}
        {% comment %} @SPK@include("partials/footer.html") {% endcomment %}
        {% include "../../partials/footer.html" %}
    </div>

    {% comment %} @SPK@include("partials/commonjs.html") {% endcomment %}
    {% include "../../partials/commonjs.html"%}

    {% comment %} @SPK@include("partials/custom_switcherjs.html") {% endcomment %}
    {% include "../../partials/custom_switcherjs.html"%}
    <!-- Custom JS -->
    <script src="../../../../static/assets/js/custom.js"></script>

    <!-- My cusotom Js -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('rewardDistributionForm');
            const messageBox = document.getElementById('responseMessage');
            
            // ‚ö†Ô∏è IMPORTANT: I am assuming 'distributionList' is the tbody of a table.
            // Ensure you have a table element in your HTML with id="distributionList"
            const distributionList = document.getElementById('distributionList');

            // Helper: read token from localStorage (try a couple common key names)
            function getAuthToken() {
                return localStorage.getItem('access_token')
                    || localStorage.getItem('accessToken')
                    || localStorage.getItem('token')
                    || null;
            }

            // Build headers including Authorization when token exists
            function authHeaders(extra = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...extra
                };
                const token = getAuthToken();
                if (token) headers['Authorization'] = `Bearer ${token}`;
                return headers;
            }

            // Fetch existing reward distributions
            fetchDistributions();

            async function fetchDistributions() {
                if (!distributionList) {
                    console.error('Error: Element with ID "distributionList" not found in the HTML.');
                    return;
                }

                try {
                    const res = await fetch('/api/rewards/', {
                        method: 'GET',
                        headers: authHeaders()
                    });

                    // NO BACKTICKS HERE (This section was inside backticks)
                    if (res.status === 401 || res.status === 403) {
                        distributionList.innerHTML = `
                            <tr><td colspan="7" class="text-center text-danger py-3">Unauthorized. Please login.</td></tr>`;
                        return;
                    }

                    const data = await res.json();
                    distributionList.innerHTML = '';

                    if (!Array.isArray(data) || data.length === 0) {
                        distributionList.innerHTML = `
                            <tr><td colspan="7" class="text-center text-muted py-3">No distributions found.</td></tr>`;
                        return;
                    }

                    data.forEach((item, index) => {
                        const distributedDate = item.distributed_at ? new Date(item.distributed_at).toLocaleString() : '-';
                        distributionList.innerHTML += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.distribution_type}</td>
                                <td>${item.start_date || '-'}</td>
                                <td>${item.end_date || '-'}</td>
                                <td>${item.total_users ?? 0}</td>
                                <td>${item.total_amount ?? 0}‡ß≥</td>
                                <td>${distributedDate}</td>
                            </tr>
                        `;
                    });
                } catch (error) {
                    console.error('Error loading distributions:', error);
                    distributionList.innerHTML = `
                        <tr><td colspan="7" class="text-center text-danger py-3">Failed to load distributions.</td></tr>`;
                }
            }

            // Handle reward distribution form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                // NO BACKTICKS HERE (This section was inside backticks)
                const formData = new FormData(form);
                const type = formData.get('distribution_type');

                messageBox.classList.add('d-none');
                messageBox.classList.remove('alert-success', 'alert-danger');

                if (!type) {
                    messageBox.classList.remove('d-none', 'alert-success');
                    messageBox.classList.add('alert-danger');
                    messageBox.innerText = 'Please select a distribution type.';
                    return;
                }

                // Ensure token present (optional: let server return 401 if not)
                const token = getAuthToken();
                if (!token) {
                    messageBox.classList.remove('d-none');
                    messageBox.classList.add('alert-danger');
                    messageBox.innerText = 'No access token found. Please login first.';
                    return;
                }

                try {
                    const res = await fetch('/api/rewards/distribute/', {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({ distribution_type: type })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        messageBox.classList.remove('d-none', 'alert-danger');
                        messageBox.classList.add('alert-success');
                        messageBox.innerText = data.message || 'Rewards distributed successfully.';
                        fetchDistributions();
                        form.reset();
                    } else if (res.status === 401 || res.status === 403) {
                        messageBox.classList.remove('d-none');
                        messageBox.classList.add('alert-danger');
                        messageBox.innerText = data.detail || 'Unauthorized. Please login with proper credentials.';
                    } else {
                        messageBox.classList.remove('d-none', 'alert-success');
                        messageBox.classList.add('alert-danger');
                        messageBox.innerText = data.error || (data.detail || 'Something went wrong.');
                    }
                } catch (error) {
                    console.error('Error distributing rewards:', error);
                    messageBox.classList.remove('d-none', 'alert-success');
                    messageBox.classList.add('alert-danger');
                    messageBox.innerText = 'Server error. Please try again later.';
                }
            });
        });

    </script>
    

</body>

</html>