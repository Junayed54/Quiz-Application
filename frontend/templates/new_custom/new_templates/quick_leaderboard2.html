{% extends 'new_custom/new_templates/index2.html' %}
{% load static %}

{% block title %}Leaderboard | Student Portal{% endblock %}

{% block style %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
    --bg-dark: #0f172a;
    --text-light: #e2e8f0;
    --accent-cyan: #66FFF0;
    --glass-bg: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(148, 163, 184, 0.1);
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark);
    color: var(--text-light);
}

/* ---------- GLASS CARD ---------- */
.glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(14px);
    border: 1px solid var(--glass-border);
    border-radius: 1.25rem;
}

/* ---------- ORBS ---------- */
.orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(120px);
    pointer-events: none;
    z-index: 0;
}

/* ---------- TEXT ---------- */
.text-gradient {
    background: linear-gradient(90deg, #fff, var(--accent-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* ---------- INPUT ---------- */
.form-control-dark {
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid var(--glass-border);
    color: white;
}
.form-control-dark:focus {
    border-color: var(--accent-cyan);
    box-shadow: 0 0 0 .25rem rgba(102,255,240,.12);
}

/* ---------- TABLE ---------- */
.table-custom {
    --bs-table-bg: transparent;
    --bs-table-color: #e2e8f0;
    --bs-table-border-color: rgba(148,163,184,.12);
}
.table-custom thead th {
    font-size: .7rem;
    text-transform: uppercase;
    letter-spacing: .05rem;
    background: rgba(15,23,42,.85);
}

/* ---------- AVATAR (LOCKED SIZE) ---------- */
.table-avatar {
    width: 34px !important;
    height: 34px !important;
    min-width: 34px;
    min-height: 34px;
    max-width: 34px;
    max-height: 34px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--accent-cyan);
}

/* ---------- PODIUM ---------- */
.podium-item {
    transition: transform .4s ease;
}
.podium-1 { transform: scale(1.12); }
.podium-2, .podium-3 { opacity: .85; }

/* ---------- BUTTON ---------- */
.btn-accent {
    background: var(--accent-cyan);
    color: #0f172a;
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="position-relative min-vh-10">

    <!-- ORBS -->
    <div class="orb" style="width:400px;height:400px;top:-120px;background:rgba(102,255,240,.08)"></div>
    <div class="orb" style="width:400px;height:400px;bottom:-120px;background:rgba(168,85,247,.08)"></div>

    <div class="container py-5 position-relative" style="z-index:5">

        <!-- HEADER -->
        <div class="row align-items-center mb-5 gy-4">
            <div class="col-md-6 text-center text-md-start">
                <div class="d-flex align-items-center gap-3 justify-content-center justify-content-md-start">
                    <div class="p-3 bg-info bg-opacity-10 rounded-3 text-info">
                        <i class="fas fa-trophy fs-3"></i>
                    </div>
                    <h1 class="fw-black text-uppercase m-0">
                        Leader<span class="text-info">board</span>
                    </h1>
                </div>
                <p class="text-secondary mt-2 mb-0">
                    Global academic ranking & performance tracking
                </p>
            </div>

            <div class="col-md-6">
                <div class="d-flex gap-3">
                    <div class="position-relative flex-grow-1">
                        <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input id="studentSearch"
                               class="form-control form-control-dark rounded-pill ps-5"
                               placeholder="Search students...">
                    </div>
                    <button class="btn btn-outline-secondary rounded-circle position-relative"
                            style="width:45px;height:45px">
                        <i class="fas fa-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger rounded-circle"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- STATS -->
        <div class="row g-4 mb-5" id="statsGrid">
            <!-- JS injects stat cards -->
        </div>

        <!-- PODIUM -->
        <section class="mb-5">
            <div class="text-center mb-4">
                <h2 class="h5 fw-bold text-gradient">
                    <i class="fas fa-medal me-2"></i>Elite Performers
                </h2>
                <div class="mx-auto bg-info rounded-pill" style="width:60px;height:3px;opacity:.5"></div>
            </div>

            <div class="row justify-content-center align-items-end g-4" id="top-performers">
                <!-- JS injects podium -->
            </div>
        </section>

        <!-- MAIN TABLE -->
        <section class="glass-card mb-5 shadow-lg overflow-hidden">
            <div class="p-4 border-bottom border-secondary border-opacity-10 d-flex justify-content-between">
                <h2 class="h6 fw-bold mb-0">Full Leaderboard</h2>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-accent">Month</button>
                    <button class="btn btn-link text-secondary">All Time</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-custom align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Rank</th>
                            <th>Student</th>
                            <th>Points</th>
                            <th>Attempts</th>
                            <th class="pe-4">Badges</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-table-body">
                        <!-- JS injects rows -->
                    </tbody>
                </table>
            </div>

            <div class="p-4 border-top border-secondary border-opacity-10 d-flex justify-content-between small text-secondary">
                <span id="message">Showing -- results</span>
                <nav id="pagination-controls"></nav>
            </div>
        </section>

        <!-- BOTTOM -->
        <div class="row g-4 mb-5">

            <!-- FILTER -->
            <div class="col-lg-4">
                <div class="glass-card p-4 mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-filter text-info me-2"></i>Filter Activity
                    </h6>

                    <input type="date" id="startDate" class="form-control form-control-dark mb-3">
                    <input type="date" id="endDate" class="form-control form-control-dark mb-3">

                    <button id="filterBtn" class="btn btn-info w-100 fw-bold">
                        Generate Report
                    </button>
                </div>
            </div>

            <!-- DAILY -->
            <div class="col-lg-8">
                <div class="glass-card h-100 overflow-hidden">
                    <div class="p-4 border-bottom border-secondary border-opacity-10">
                        <h6 class="fw-bold mb-0">
                            <i class="fas fa-bolt text-warning me-2"></i>
                            Today's Performers
                        </h6>
                    </div>

                    <table class="table table-custom align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th class="text-start">User</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="scorerTable">
                            <!-- JS injects -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block body_js %}
<script src="../../../static/Js/quickquiz/leaderboard.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const apiURL = "/api/top-scorers/";
    const tableBody = document.getElementById("scorerTable");
    const message = document.getElementById("message");

    // ---------- FUNCTION: LOAD LEADERBOARD (Daily or Range) ----------
    async function loadTopScorers(params = "") {
        tableBody.innerHTML = "";
        message.textContent = "Loading...";

        try {
            const res = await fetch(`${apiURL}${params}`, {
                headers: { "Content-Type": "application/json" },
            });

            if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

            const data = await res.json();
            console.log("Leaderboard:", data);

            if (!data.leaderboard || data.leaderboard.length === 0) {
                message.textContent = "";
                return;
            }

            message.textContent = "";

            // Render leaderboard
            data.leaderboard.forEach((item, index) => {
                const row = `
                    <tr class="${index === 0 ? 'bg-success' : ''}">
                        <td class="px-4 py-3 text-sm fw-bold text-white"><strong>#${index + 1}</strong></td>
                        <td class="px-4 py-3 text-sm fw-bold text-white">${item.username}</td>
                        <td class="px-4 py-3 text-sm fw-bold text-white">
                            <span class="badge bg-primary fs-6">${item.total_score}</span>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML("beforeend", row);
            });

        } catch (err) {
            console.error(err);
            message.textContent = "⚠️ Unable to load leaderboard.";
        }
    }

    // ---------- LOAD TODAY'S DATA BY DEFAULT ----------
    loadTopScorers();

    // ---------- RANGE FILTER ----------
    const filterBtn = document.getElementById("filterBtn");

    if (filterBtn) {
        filterBtn.addEventListener("click", () => {
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;

            if (!start || !end) {
                message.textContent = "Please select both start & end date.";
                return;
            }

            loadTopScorers(`?start_date=${start}&end_date=${end}`);
        });
    }
});
</script>
{% endblock %}
