{% extends 'new_custom/new_templates/index2.html' %}
{% load static %}

{% block title %}Leaderboard | Student Portal{% endblock %}

{% block style %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

:root {
    --bg-dark: #0f172a;
    --text-light: #e2e8f0;
    --accent-cyan: #66FFF0;
    --glass-bg: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(148, 163, 184, 0.1);
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-dark);
    color: var(--text-light);
}

/* ---------- GLASS CARD ---------- */
.glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(14px);
    border: 1px solid var(--glass-border);
    border-radius: 1.25rem;
}

/* ---------- ORBS ---------- */
.orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(120px);
    pointer-events: none;
    z-index: 0;
}

/* ---------- TEXT ---------- */
.text-gradient {
    background: linear-gradient(90deg, #fff, var(--accent-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* ---------- INPUT ---------- */
.form-control-dark {
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid var(--glass-border);
    color: white;
}
.form-control-dark:focus {
    border-color: var(--accent-cyan);
    box-shadow: 0 0 0 .25rem rgba(102,255,240,.12);
}

/* ---------- TABLE ---------- */
.table-custom {
    --bs-table-bg: transparent;
    --bs-table-color: #e2e8f0;
    --bs-table-border-color: rgba(148,163,184,.12);
}
.table-custom thead th {
    font-size: .7rem;
    text-transform: uppercase;
    letter-spacing: .05rem;
    background: rgba(15,23,42,.85);
}

/* ---------- AVATAR (LOCKED SIZE) ---------- */
.table-avatar {
    width: 34px !important;
    height: 34px !important;
    min-width: 34px;
    min-height: 34px;
    max-width: 34px;
    max-height: 34px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--accent-cyan);
}

/* ---------- PODIUM ---------- */
.podium-item {
    transition: transform .4s ease;
}
.podium-1 { transform: scale(1.12); }
.podium-2, .podium-3 { opacity: .85; }

/* ---------- BUTTON ---------- */
.btn-accent {
    background: var(--accent-cyan);
    color: #0f172a;
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="position-relative min-vh-10">

    <!-- ORBS -->
    <div class="orb" style="width:400px;height:400px;top:-120px;background:rgba(102,255,240,.08)"></div>
    <div class="orb" style="width:400px;height:400px;bottom:-120px;background:rgba(168,85,247,.08)"></div>

    <div class="container py-5 position-relative" style="z-index:5">

        <!-- HEADER -->
        <div class="row align-items-center mb-5 gy-4">
            <div class="col-md-6 text-center text-md-start">
                <div class="d-flex align-items-center gap-3 justify-content-center justify-content-md-start">
                    <div class="p-3 bg-info bg-opacity-10 rounded-3 text-info">
                        <i class="fas fa-trophy fs-3"></i>
                    </div>
                    <h1 class="fw-black text-uppercase m-0">
                        Leader<span class="text-info">board</span>
                    </h1>
                </div>
                <p class="text-secondary mt-2 mb-0">
                    Global academic ranking & performance tracking
                </p>
            </div>

            <div class="col-md-6">
                <div class="d-flex gap-3">
                    <div class="position-relative flex-grow-1">
                        <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input id="studentSearch"
                               class="form-control form-control-dark rounded-pill ps-5"
                               placeholder="Search students...">
                    </div>
                    <button class="btn btn-outline-secondary rounded-circle position-relative"
                            style="width:45px;height:45px">
                        <i class="fas fa-bell"></i>
                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger rounded-circle"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- STATS -->
        <div class="row g-4 mb-5" id="statsGrid">
            <!-- JS injects stat cards -->
        </div>

        <!-- PODIUM -->
        <section class="mb-5">
            <div class="text-center mb-4">
                <h2 class="h5 fw-bold text-gradient">
                    <i class="fas fa-medal me-2"></i>Elite Performers
                </h2>
                <div class="mx-auto bg-info rounded-pill" style="width:60px;height:3px;opacity:.5"></div>
            </div>

            <div class="row justify-content-center align-items-end g-4" id="top-performers">
                <!-- JS injects podium -->
            </div>
        </section>

        <!-- MAIN TABLE -->
        <section class="glass-card mb-5 shadow-lg overflow-hidden">
            <div class="p-4 border-bottom border-secondary border-opacity-10 d-flex justify-content-between">
                <h2 class="h6 fw-bold mb-0">Full Leaderboard</h2>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-accent">Month</button>
                    <button class="btn btn-link text-secondary">All Time</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-custom align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Rank</th>
                            <th>Student</th>
                            <th>Points</th>
                            <th>Attempts</th>
                            <th class="pe-4">Badges</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-table-body">
                        <!-- JS injects rows -->
                    </tbody>
                </table>
            </div>

            <div class="p-4 border-top border-secondary border-opacity-10 d-flex justify-content-between small text-secondary">
                <span id="message">Showing -- results</span>
                <nav id="pagination-controls"></nav>
            </div>
        </section>

        <!-- BOTTOM -->
        <div class="row g-4 mb-5">

            <!-- FILTER -->
            <div class="col-lg-4">
                <div class="glass-card p-4 mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-filter text-info me-2"></i>Filter Activity
                    </h6>

                    <input type="date" id="startDate" class="form-control form-control-dark mb-3">
                    <input type="date" id="endDate" class="form-control form-control-dark mb-3">

                    <button id="filterBtn" class="btn btn-info w-100 fw-bold">
                        Generate Report
                    </button>
                </div>
            </div>

            <!-- DAILY -->
            <div class="col-lg-8">
                <div class="glass-card h-100 overflow-hidden">
                    <div class="p-4 border-bottom border-secondary border-opacity-10">
                        <h6 class="fw-bold mb-0">
                            <i class="fas fa-bolt text-warning me-2"></i>
                            Today's Performers
                        </h6>
                    </div>

                    <table class="table table-custom align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th class="text-start">User</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="scorerTable">
                            <!-- JS injects -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block body_js %}
<!-- <script src="../../../static/Js/quickquiz/leaderboard.js"></script> -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

    // --- State Management ---
    const usersPerPage = 10;
    let currentPage = 1;
    let allLeaderboardUsers = []; 
    let currentUserData = null; 

    // --- Helper: Initials for Fallback Avatars ---
    function getInitials(fullName) {
        if (!fullName) return "??";
        const matches = fullName.match(/\b\w/g) || [];
        return matches.map(char => char.toUpperCase()).join('').substring(0, 2);
    }

    // --- Helper: Django Static Paths ---
    function getStaticImageUrl(imageName) {
        return `/static/images/${imageName}`;
    }

    // --- Initialization & API Fetching ---
    const token = localStorage.getItem("access_token");
    const phoneNumber = localStorage.getItem("phone_number");
    let leaderboardUrl = "/api/practice/leaderboard/";

    if (!token && phoneNumber) {
        leaderboardUrl += `?phone_number=${encodeURIComponent(phoneNumber)}`;
    }

    const headers = { "Content-Type": "application/json" };
    if (token) {
        headers["Authorization"] = `Bearer ${token}`;
    }

    fetch(leaderboardUrl, { method: "GET", headers: headers })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log("✅ Leaderboard Data Received");

            if (data.top_10 && Array.isArray(data.top_10)) {
                allLeaderboardUsers = data.top_10;
                currentUserData = data.me;
                
                // Trigger UI Renders
                renderTopThreePerformers(allLeaderboardUsers);
                renderLeaderboardPage(currentPage, currentUserData);
                setupPagination(allLeaderboardUsers.length);
            }

            if (data.me) {
                updateMyStats(data.me);
            }
        })
        .catch(error => {
            console.error("❌ Leaderboard Fetch Error:", error);
        });

    // --- UI Component: Personal Stats (Top Header) ---
    function updateMyStats(me) {
        const myRankElement = document.getElementById("my_rank");
        const myPointsElement = document.getElementById("my_points");
        const myCompletedTasksElement = document.getElementById("my_complete_test");
        
        // Find progress section relative to the stats card
        const statCard = document.querySelector("#my_complete_test")?.closest(".card-dark-bg");
        const progressSection = statCard?.nextElementSibling;

        if (myRankElement) myRankElement.innerText = `#${me.rank || '--'}`;
        if (myPointsElement) myPointsElement.innerText = `${(me.points || 0).toLocaleString()}`;
        if (myCompletedTasksElement) myCompletedTasksElement.innerText = `${me.attempts || '0'}/--`;

        if (progressSection) {
            const percText = progressSection.querySelector("h3");
            const nextRankText = progressSection.querySelector(".small span:first-child");
            const pointsNeededText = progressSection.querySelector(".small span:last-child");
            const progressBar = progressSection.querySelector(".progress-bar");

            const progress = me.progress_to_next_rank ?? 0;
            if (percText) percText.innerText = `${progress}%`;
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
            if (nextRankText) nextRankText.innerText = `Rank #${me.next_rank_details?.rank || '--'}`;
            if (pointsNeededText) pointsNeededText.innerText = `${me.next_rank_details?.points_needed || '0'} points needed`;
        }
    }

    // --- UI Component: Top 3 Podium Cards ---
    function renderTopThreePerformers(users) {
        const container = document.getElementById("top-performers");
        if (!container || !users || users.length === 0) return;

        const top3 = users.slice(0, 3);
        container.innerHTML = "";

        // Style configurations for 1st, 2nd, and 3rd place
        const styles = [
            { // 1st Place (Index 0)
                grad: "linear-gradient(149.8deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 215, 0, 0.08) 100%)",
                border: "1px solid #FFD700",
                accent: "#FFD700",
                shadow: "0px 20px 20px 0px #FFD7004D",
                btnStyle: "background: linear-gradient(75.81deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.15) 100%); border: 1px solid #FFD700; color: #FFD700;",
                label: "Top Performer"
            },
            { // 2nd Place (Index 1)
                grad: "linear-gradient(149.78deg, rgba(16, 38, 51, 0.9) 0%, rgba(11, 26, 38, 0.95) 100%)",
                border: "1px solid #0FFFE6",
                accent: "#C0C0C0",
                shadow: "0px 20px 20px 0px #00FFCC40",
                btnStyle: "background: linear-gradient(74.07deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.15) 100%); border: 1px solid #C0C0C0; color: #C0C0C0;",
                label: "Fast Learner"
            },
            { // 3rd Place (Index 2)
                grad: "linear-gradient(149.8deg, rgba(16, 38, 51, 0.9) 0%, rgba(11, 26, 38, 0.95) 100%)",
                border: "1px solid #13E0B44D",
                accent: "#CD7F32",
                shadow: "0px 20px 20px 0px #00000066",
                btnStyle: "background: linear-gradient(72.56deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.15) 100%); border: 1px solid #CD7F32; color: #CD7F32;",
                label: "Consistent"
            }
        ];
        
        // Podium order display: 2nd place on left, 1st in middle, 3rd on right
        const displayOrder = [1, 0, 2]; 

        displayOrder.forEach((originalIndex) => {
            const user = top3[originalIndex];
            if (!user) return;

            const config = styles[originalIndex];
            const profileImg = user.profile_image || getStaticImageUrl('user.png');
            const col = document.createElement("div");
            
            // Handle responsive column ordering
            col.className = `col-4 px-1 px-md-3 order-${originalIndex === 0 ? 1 : originalIndex === 1 ? 0 : 2}`;

            col.innerHTML = `
                <div class="position-relative p-2 p-md-3 text-center top-performer-card h-100 shadow-lg" 
                     style="background: ${config.grad}; border: ${config.border}; border-radius: 20px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 280px;">
                    
                    <span class="position-absolute end-0 translate-middle badge rounded-pill text-white fw-bold" 
                          style="background-color:${config.accent}; font-size: 16px; padding: 6px 12px; top: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                        #${originalIndex + 1}
                    </span>

                    <div class="rounded-circle overflow-hidden mb-3" style="width: 75px; height: 75px; border: 3px solid ${config.accent}; margin-top: 1.5rem;">
                        ${user.profile_image ? 
                            `<img src="${profileImg}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            `<div class="d-flex align-items-center justify-content-center h-100 bg-secondary text-white fw-bold">${getInitials(user.username)}</div>`
                        }
                    </div>

                    <div class="text-white fw-bold small mb-1 text-truncate w-100">${user.username}</div>
                    <div class="text-custom-gradient h5 fw-bold mb-3">${(user.points || 0).toLocaleString()} <span class="small" style="font-size: 10px;">PTS</span></div>
                    
                    <button class="btn btn-xs rounded-pill w-100 fw-bold text-uppercase" style="${config.btnStyle} font-size: 9px; letter-spacing: 0.5px;">
                        ${config.label}
                    </button>
                </div>
            `;
            container.appendChild(col);
        });
    }

    // --- UI Component: Main Leaderboard Table ---
    function renderLeaderboardPage(page, meData) {
        const tableBody = document.getElementById("leaderboard-table-body");
        if (!tableBody) return;
        
        tableBody.innerHTML = ""; 

        const start = (page - 1) * usersPerPage;
        const slice = allLeaderboardUsers.slice(start, start + usersPerPage);

        slice.forEach((user, index) => {
            const actualRank = start + index + 1;
            const isMe = (meData && String(user.username) === String(meData.username));
            const profileImg = user.profile_image || getStaticImageUrl('user.png');

            let badge = '';
            if (actualRank === 1) badge = `<span class="table-badge table-badge-top">Top Performer</span>`;
            else if (actualRank === 2) badge = `<span class="table-badge table-badge-fast">Fast Learner</span>`;
            else if (actualRank === 3) badge = `<span class="table-badge table-badge-consistent">Consistent</span>`;

            tableBody.innerHTML += `
                <tr class="align-middle ${isMe ? 'leaderboard-you-row' : ''}">
                    <td class="px-4 py-3">
                        <span class="d-inline-flex align-items-center justify-content-center fw-bold rounded-circle 
                            ${actualRank === 1 ? 'bg-warning text-dark' : actualRank === 2 ? 'bg-info text-dark' : actualRank === 3 ? 'bg-primary text-dark' : 'text-secondary'}" 
                            style="width: 30px; height: 30px; font-size: 0.85rem;">
                            ${actualRank}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="d-flex align-items-center gap-3">
                            <img src="${profileImg}" class="rounded-circle border border-secondary" style="width: 35px; height: 35px; object-fit: cover;">
                            <span class="fw-bold ${isMe ? 'text-info' : 'text-white'}">${user.username}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-secondary">${user.attempts || '0'}</td>
                    <td class="px-4 py-3 fw-bold ${isMe ? 'text-info' : 'text-white'}">${(user.points || 0).toLocaleString()}</td>
                    <td class="px-4 py-3">${badge}</td>
                </tr>`;
        });
    }

    // --- UI Component: Pagination Logic ---
    function setupPagination(total) {
        const navContainer = document.getElementById("pagination-controls");
        if (!navContainer) return;

        const pages = Math.ceil(total / usersPerPage);
        navContainer.innerHTML = ''; 
        if (pages <= 1) return;

        const ul = document.createElement("ul");
        ul.className = "pagination justify-content-center mt-4 gap-1";

        // Previous Button
        ul.appendChild(createPageBtn("Previous", currentPage > 1, () => {
            currentPage--;
            refreshUI();
        }));

        // Number Buttons
        for (let i = 1; i <= pages; i++) {
            const li = createPageBtn(i, true, () => {
                currentPage = i;
                refreshUI();
            });
            if (i === currentPage) li.querySelector('a').classList.add("active", "bg-info", "border-info");
            ul.appendChild(li);
        }

        // Next Button
        ul.appendChild(createPageBtn("Next", currentPage < pages, () => {
            currentPage++;
            refreshUI();
        }));

        navContainer.appendChild(ul);
    }

    function createPageBtn(label, active, action) {
        const li = document.createElement("li");
        li.className = `page-item ${!active ? 'disabled' : ''}`;
        li.innerHTML = `<a class="page-link bg-dark border-secondary text-white rounded px-3" href="#">${label}</a>`;
        if (active) {
            li.addEventListener("click", (e) => {
                e.preventDefault();
                action();
            });
        }
        return li;
    }

    function refreshUI() {
        renderLeaderboardPage(currentPage, currentUserData);
        setupPagination(allLeaderboardUsers.length);
        // Scroll to table top on page change
        document.getElementById('leaderboard-table-body')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const apiURL = "/api/top-scorers/";
    const tableBody = document.getElementById("scorerTable");
    const message = document.getElementById("message");

    // ---------- FUNCTION: LOAD LEADERBOARD (Daily or Range) ----------
    async function loadTopScorers(params = "") {
        tableBody.innerHTML = "";
        message.textContent = "Loading...";

        try {
            const res = await fetch(`${apiURL}${params}`, {
                headers: { "Content-Type": "application/json" },
            });

            if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);

            const data = await res.json();
            console.log("Leaderboard:", data);

            if (!data.leaderboard || data.leaderboard.length === 0) {
                message.textContent = "";
                return;
            }

            message.textContent = "";

            // Render leaderboard
            data.leaderboard.forEach((item, index) => {
                const row = `
                    <tr class="${index === 0 ? 'bg-success' : ''}">
                        <td class="px-4 py-3 text-sm fw-bold text-white"><strong>#${index + 1}</strong></td>
                        <td class="px-4 py-3 text-sm fw-bold text-white">${item.username}</td>
                        <td class="px-4 py-3 text-sm fw-bold text-white">
                            <span class="badge bg-primary fs-6">${item.total_score}</span>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML("beforeend", row);
            });

        } catch (err) {
            console.error(err);
            message.textContent = "⚠️ Unable to load leaderboard.";
        }
    }

    // ---------- LOAD TODAY'S DATA BY DEFAULT ----------
    loadTopScorers();

    // ---------- RANGE FILTER ----------
    const filterBtn = document.getElementById("filterBtn");

    if (filterBtn) {
        filterBtn.addEventListener("click", () => {
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;

            if (!start || !end) {
                message.textContent = "Please select both start & end date.";
                return;
            }

            loadTopScorers(`?start_date=${start}&end_date=${end}`);
        });
    }
});
</script>
{% endblock %}
