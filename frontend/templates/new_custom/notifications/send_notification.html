{% extends 'new_custom/new_templates/index2.html' %}

{% block title %}চাকরি নিউজ{% endblock %}

{% block style %}
<style>
  .notify-btn {
    background: #2563eb; /* Tailwind blue-600 */
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }
  .notify-btn:hover {
    background: #1d4ed8; /* Darker blue */
  }
</style>
{% endblock %}

{% block content %}
<button id="enable-notifications" style="display: none;">Enable notifications</button>

<!-- firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";
  //import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCpnkyTVh76T6aIdpi_LpxIiV47Jw9V7Hg",
    authDomain: "jobs-academy.firebaseapp.com",
    projectId: "jobs-academy",
    storageBucket: "jobs-academy.firebasestorage.app",
    messagingSenderId: "524525708923",
    appId: "1:524525708923:web:09f0ba0e9eae09267ea4de",
    measurementId: "G-11T4YEDB7B"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  // const analytics = getAnalytics(app);


  const messaging = getMessaging(app);
  const vapidKey = "BFMGzMAe0aF68SMjCu4SlR6zcsPuRjmKmSmv72AebLIMicG3-_LgqlFPTh4AeQiIAiaoHSZQNjFuHNqXNjGX-YA"; // From app settings >> 'cloud messaging' tab >> key pair. 
  const btn = document.getElementById('enable-notifications');

  // Get CSRF token from cookie
  const getCSRF = () => {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : null;
  };

  const saveToken = (token) => {
  fetch('save-fcm-token/', { // Here update the API endpoint as per your setup.
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRF(),
        },
        credentials: 'include',
        body: JSON.stringify({ token })
  })
  .then(res => res.json())
  .then(data => console.log('Token saved:', data))
  .catch(err => console.error('Save failed:', err));
  };

  const requestAndSendToken = (registration) => {
        getToken(messaging, { vapidKey, serviceWorkerRegistration: registration })
        .then((token) => {
        if (token) {
            console.log("FCM Token:", token);
            saveToken(token);
        } else {
            console.warn("No token available.");
        }
        })
        .catch(err => console.error("Token error:", err));
  };

  if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then((reg) => {
            console.log('Service Worker registered');
  
        if (Notification.permission === 'granted') {
            requestAndSendToken(reg);
        } else if (Notification.permission !== 'denied') {
            btn.style.display = 'inline-block';
            btn.addEventListener('click', () => {
            Notification.requestPermission().then(permission => {
                  if (permission === 'granted') requestAndSendToken(reg);
                  else console.warn("Permission denied by user.");
            });
            });
        } else {
            console.warn("Notifications denied earlier.");
        }
        })
        .catch(err => console.error("SW registration failed:", err));
  }

</script>
{% endblock %}