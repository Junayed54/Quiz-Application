{% extends 'new_custom/new_templates/index2.html' %}
{% load static %}

{% block title %}Leaderboard - Colored Columns{% endblock %}

{% block style %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
    --bg-body: #0b1220;
    --card-bg: rgba(255, 255, 255, 0.04);
    --text-main: #ffffff;
    --text-soft: #94a3b8;
    --border-color: rgba(255, 255, 255, 0.1);
}

body { 
    background: radial-gradient(circle at top right, #1e1b4b, #0b1220, #020617);
    color: var(--text-main); 
    font-family: 'Inter', sans-serif; 
    min-height: 100vh;
}

/* --- GAME SELECTION --- */
#mobileGameFilter { display: none; }
@media (max-width: 768px) {
    #mobileGameFilter { display: block; }
    .game-selection-column { display: flex; overflow-x: auto; padding: 10px 0 20px 0; }
    .game-item {
        background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color);
        color: var(--text-soft); padding: 10px 20px; border-radius: 12px;
        backdrop-filter: blur(10px); cursor: pointer; white-space: nowrap;
    }
    .game-item.active { background: #6366f1; color: white; }
}

/* --- LEADERBOARD CARD --- */
.leaderboard-card {
    background: var(--card-bg); border-radius: 24px; padding: 1.5rem;
    backdrop-filter: blur(20px); border: 1px solid var(--border-color);
}

.table-responsive {
    border-radius: 16px; border: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.3);
}

/* STICKY PLAYER NAME (Kept dark for contrast) */
.sticky-rank {
    position: sticky; left: 0; width: 60px;
    background: #0f172a !important; z-index: 10; text-align: center;
}

.sticky-user {
    position: sticky; left: 60px; width: 150px;
    background: #0f172a !important; z-index: 10;
    color: #ffffff !important; font-weight: 700 !important;
    border-right: 2px solid var(--border-color) !important;
}

/* --- COLUMN BACKGROUND STYLING --- */
.table td, .table th {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border: none;
}

.total-score-cell {
    background: rgba(45, 212, 191, 0.1) !important; /* Teal background for total */
    color: #2dd4bf !important;
    font-weight: 800;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div id="mobileGameFilter" class="mb-3">
        <label class="small text-soft fw-bold mb-2">SELECT GAME</label>
        <div class="game-selection-column" id="gameListContainer"></div>
    </div>

    <div class="leaderboard-card">
        <h4 class="fw-bold mb-4" id="displayGameTitle">Leaderboard</h4>

        <div class="row g-3 mb-4 align-items-end">
            <div class="col-5"><input type="date" id="fromDate" class="form-control bg-dark text-white border-secondary"></div>
            <div class="col-5"><input type="date" id="toDate" class="form-control bg-dark text-white border-secondary"></div>
            <div class="col-2"><button id="filterBtn" class="btn btn-primary w-100">Apply</button></div>
        </div>

        <div class="table-responsive">
            <table class="table d-none" id="leaderboardTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            <div id="initialState" class="p-5 text-center text-soft">Select dates to load leaderboard.</div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
<script>
// These colors will be used for the column backgrounds (low opacity)
const columnBgColors = [
    'rgba(251, 191, 36, 0.15)', // Amber
    'rgba(244, 114, 182, 0.15)', // Pink
    'rgba(52, 211, 153, 0.15)', // Emerald
    'rgba(96, 165, 250, 0.15)', // Blue
    'rgba(167, 139, 250, 0.15)'  // Violet
];

// Matching text colors for the headers
const columnTextColors = ['#fbbf24', '#f472b6', '#34d399', '#60a5fa', '#a78bfa'];

let selectedGameId = null;

document.addEventListener("DOMContentLoaded", () => {
    loadGames();
    document.getElementById("filterBtn").addEventListener("click", fetchLeaderboard);
});

function loadGames() {
    fetch('/api/word-game/list/').then(res => res.json()).then(data => {
        const container = document.getElementById("gameListContainer");
        data.games.forEach((game, i) => {
            const div = document.createElement("div");
            div.className = `game-item ${i === 0 ? 'active' : ''}`;
            div.innerText = game.name;
            div.onclick = function() {
                document.querySelectorAll('.game-item').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                selectedGameId = game.id;
                document.getElementById('displayGameTitle').innerText = game.name;
            };
            container.appendChild(div);
            if (i === 0) selectedGameId = game.id;
        });
    });
}

function fetchLeaderboard() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    document.getElementById("initialState").classList.add("d-none");
    document.getElementById("leaderboardTable").classList.remove("d-none");

    fetch(`/api/word-game/leaderboard/?game_id=${selectedGameId}&from_date=${fromDate}&to_date=${toDate}`)
        .then(res => res.json())
        .then(data => {
            const head = document.getElementById("tableHead");
            const body = document.getElementById("tableBody");
            const titles = data.results.puzzle_titles || [];
            const players = data.results.results || [];

            // Build Head
            let headHTML = `<tr><th class="sticky-rank">#</th><th class="sticky-user">Player</th>`;
            titles.forEach((t, i) => {
                const color = columnTextColors[i % columnTextColors.length];
                const bg = columnBgColors[i % columnBgColors.length];
                headHTML += `<th class="text-center" style="color: ${color}; background: ${bg}">${t}</th>`;
            });
            headHTML += `<th class="text-center total-score-cell">Total</th></tr>`;
            head.innerHTML = headHTML;

            // Build Rows
            body.innerHTML = "";
            players.forEach(p => {
                let rowHTML = `<tr><td class="sticky-rank text-secondary">${p.rank}</td><td class="sticky-user">${p.username}</td>`;
                titles.forEach((t, i) => {
                    const bg = columnBgColors[i % columnBgColors.length];
                    rowHTML += `<td class="text-center" style="background: ${bg}; color: #fff; font-weight: 500;">${p[t] ?? 0}</td>`;
                });
                rowHTML += `<td class="text-center total-score-cell">${p.total_score ?? 0}</td></tr>`;
                body.insertAdjacentHTML("beforeend", rowHTML);
            });
        });
}
</script>
{% endblock %}