{% extends 'new_custom/new_templates/index2.html' %}
{% load static %}

{% block title %}Leaderboard - Glass Edition{% endblock %}

{% block style %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
    --bg-body: #0b1220;
    --card-bg: rgba(255, 255, 255, 0.04);
    --accent-indigo: #6366f1;
    --text-main: #ffffff;
    --text-soft: #94a3b8;
    --border-color: rgba(255, 255, 255, 0.1);
}

body { 
    background: radial-gradient(circle at top right, #1e1b4b, #0b1220, #020617);
    color: var(--text-main); 
    font-family: 'Inter', sans-serif; 
    min-height: 100vh;
}

/* --- MOBILE GAME SELECTION (Transparent) --- */
#mobileGameFilter { display: none; }

@media (max-width: 768px) {
    #mobileGameFilter { display: block; }
    .game-selection-column {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 10px 0 20px 0;
        scrollbar-width: none;
    }
    .game-selection-column::-webkit-scrollbar { display: none; }

    .game-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-soft);
        padding: 10px 20px;
        border-radius: 12px;
        white-space: nowrap;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .game-item.active {
        background: var(--accent-indigo);
        color: white;
        border-color: var(--accent-indigo);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
}

/* --- LEADERBOARD CARD & DATE FILTERS --- */
.leaderboard-card {
    background: var(--card-bg);
    border-radius: 24px;
    padding: 1.5rem;
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.filter-panel {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 16px;
    padding: 1.2rem;
    border: 1px solid var(--border-color);
    margin-bottom: 1.5rem;
}

.form-control {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid var(--border-color) !important;
    color: white !important;
    font-size: 0.9rem;
}

.form-control::-webkit-calendar-picker-indicator {
    filter: invert(1); /* Makes the calendar icon white */
}

/* --- TABLE TRANSPARENCY & PLAYER VISIBILITY --- */
.table-responsive {
    border-radius: 16px;
    border: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.2);
}

.table { color: var(--text-main); margin-bottom: 0; background: transparent !important; }

.table thead th {
    background: rgba(255, 255, 255, 0.08) !important;
    color: var(--accent-indigo);
    border: none;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 1px;
    padding: 1rem;
}

/* STICKY COLUMNS - CRITICAL FOR PLAYER VISIBILITY */
.sticky-rank {
    position: sticky; left: 0; width: 60px;
    background: #111827 !important; /* Slightly darker so text doesn't overlap */
    z-index: 10; text-align: center;
}

.sticky-user {
    position: sticky; left: 60px; width: 150px;
    background: #111827 !important; /* Darker background for visibility */
    z-index: 10;
    color: #ffffff !important; /* FORCED WHITE */
    font-weight: 700 !important;
    border-right: 1px solid var(--border-color) !important;
}

.rank-circle {
    width: 28px; height: 28px; line-height: 28px; border-radius: 50%;
    font-weight: 800; display: inline-block; font-size: 0.8rem;
}
.rank-1 { background: #fbbf24; color: #000; }

.btn-update {
    background: var(--accent-indigo);
    border: none;
    font-weight: 700;
    transition: 0.3s;
}
.btn-update:hover { background: #4f46e5; transform: scale(1.02); }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    
    <!-- <div id="mobileGameFilter" class="mb-3">
        <label class="small text-soft fw-bold mb-2">SELECT GAME</label>
        <div class="game-selection-column" id="gameListContainer">
            <div class="text-soft small">Fetching Games...</div>
        </div>
    </div> -->

    <div class="leaderboard-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold mb-0" id="displayGameTitle">Leaderboard</h4>
            <div id="loader" class="spinner-border spinner-border-sm text-light d-none"></div>
        </div>

        <div class="filter-panel">
            <div class="row g-3 align-items-end">
                <div class="col-6 col-md-4">
                    <label class="x-small text-soft fw-bold mb-1">FROM</label>
                    <input type="date" id="fromDate" class="form-control">
                </div>
                <div class="col-6 col-md-4">
                    <label class="x-small text-soft fw-bold mb-1">TO</label>
                    <input type="date" id="toDate" class="form-control">
                </div>
                <div class="col-12 col-md-4">
                    <button id="filterBtn" class="btn btn-update w-100 text-white">Apply Filters</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table" id="leaderboardTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
            <span class="text-soft small" id="pageDisplay"></span>
            <div class="btn-group">
                <button id="prevPage" class="btn btn-sm btn-outline-light px-3" disabled>Previous</button>
                <button id="nextPage" class="btn btn-sm btn-outline-light px-3" disabled>Next</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
<script>
let currentPage = 1;
let selectedGameId = null;

document.addEventListener("DOMContentLoaded", () => {
    loadGames(); // Step 1: Load Games

    // Filter Logic
    document.getElementById("filterBtn").addEventListener("click", () => {
        currentPage = 1;
        fetchLeaderboard();
    });

    // Pagination Logic
    document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) { currentPage--; fetchLeaderboard(); }
    });
    document.getElementById("nextPage").addEventListener("click", () => {
        currentPage++; fetchLeaderboard();
    });
});

function loadGames() {
    fetch('/api/word-game/list/') 
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById("gameListContainer");
            container.innerHTML = ""; 

            if (data.games && data.games.length > 0) {
                data.games.forEach((game, index) => {
                    const div = document.createElement("div");
                    div.className = `game-item ${index === 0 ? 'active' : ''}`;
                    div.innerText = game.name;
                    div.dataset.id = game.id;
                    
                    if (index === 0) {
                        selectedGameId = game.id;
                        document.getElementById('displayGameTitle').innerText = game.name;
                    }

                    div.onclick = function() {
                        document.querySelectorAll('.game-item').forEach(el => el.classList.remove('active'));
                        this.classList.add('active');
                        selectedGameId = this.dataset.id;
                        document.getElementById('displayGameTitle').innerText = this.innerText;
                        currentPage = 1;
                        fetchLeaderboard();
                    };
                    container.appendChild(div);
                });
                fetchLeaderboard(); // Automatically load the first game
            }
        });
}

function fetchLeaderboard() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    const loader = document.getElementById("loader");

    loader.classList.remove("d-none");

    let url = `/api/word-game/leaderboard/?page=${currentPage}`;
    if (selectedGameId) url += `&game_id=${selectedGameId}`;
    if (fromDate) url += `&from_date=${fromDate}`;
    if (toDate) url += `&to_date=${toDate}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            loader.classList.add("d-none");
            const tableHead = document.getElementById("tableHead");
            const tableBody = document.getElementById("tableBody");
            
            const payload = data.results || {};
            const puzzleTitles = payload.puzzle_titles || [];
            const players = payload.results || [];

            if (!players.length) {
                tableBody.innerHTML = `<tr><td colspan="100" class="text-center py-5 text-soft">No data found for these dates.</td></tr>`;
                return;
            }

            // Headers
            let headHTML = `<tr><th class="sticky-rank">#</th><th class="sticky-user">Player</th>`;
            puzzleTitles.forEach(t => headHTML += `<th class="text-center">${t}</th>`);
            headHTML += `<th class="text-center">Total</th></tr>`;
            tableHead.innerHTML = headHTML;

            // Rows
            tableBody.innerHTML = "";
            players.forEach(player => {
                let rankClass = player.rank <= 3 ? `rank-${player.rank}` : "";
                let rowHTML = `<tr>
                    <td class="sticky-rank"><span class="rank-circle ${rankClass}">${player.rank}</span></td>
                    <td class="sticky-user">${player.username}</td>`; // CSS handles the white color
                
                puzzleTitles.forEach(t => {
                    rowHTML += `<td class="text-center">${player[t] ?? 0}</td>`;
                });
                rowHTML += `<td class="text-center fw-bold text-info">${player.total_score ?? 0}</td></tr>`;
                tableBody.insertAdjacentHTML("beforeend", rowHTML);
            });

            document.getElementById("pageDisplay").innerText = `Page ${currentPage}`;
            document.getElementById("prevPage").disabled = !data.previous;
            document.getElementById("nextPage").disabled = !data.next;
        });
}
</script>
{% endblock %}