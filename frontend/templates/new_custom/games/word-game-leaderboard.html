{% extends 'new_custom/new_templates/index2.html' %}
{% load static %}

{% block title %}Mixup - Word Scramble Game Leaderboard{% endblock %}

{% block style %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
    background: linear-gradient(to right, #7e1e3b, #b53856, #2d0b54, #120336);
    min-height: 100vh;
    color: white;
}
.table-container {
    background: #210a42;
    padding: 20px;
    border-radius: 10px;
    margin-top: 30px;
}
.table thead th {
    background-color: #3a0d58;
    color: white;
    text-align: center;
}
.table tbody td {
    text-align: center;
    vertical-align: middle;
}
.date-range {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
}
.date-range input,
.date-range button {
    border-radius: 5px;
    border: none;
    padding: 5px 10px;
}
.date-range button {
    background-color: #3a0d58;
    color: white;
    cursor: pointer;
}
.date-range button:hover {
    background-color: #1f0842;
}
.pagination-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
}
.pagination-container button {
    padding: 5px 10px;
    border-radius: 5px;
    background-color: #3a0d58;
    color: white;
    border: none;
    cursor: pointer;
}
.pagination-container button:disabled {
    background-color: #777;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="table-container shadow-lg mb-3">
        <h2 class="text-center mb-4">Word Game Leaderboard</h2>

        <div class="date-range">
            <input type="date" id="fromDate" class="form-control">
            <input type="date" id="toDate" class="form-control">
            <button id="filterBtn" class="btn btn-primary">Filter</button>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="leaderboardTable">
                <thead id="tableHead">
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <!-- Dynamic Game Titles -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="10" class="text-center">Loading leaderboard...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <button id="prevPage" disabled>Previous</button>
            <button id="nextPage" disabled>Next</button>
        </div>
    </div>
</div>
{% endblock %}

{% block body_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    fetchLeaderboard();

    document.getElementById("filterBtn").addEventListener("click", () => {
        currentPage = 1;
        fetchLeaderboard();
    });
});

let currentPage = 1;

function fetchLeaderboard(page = 1) {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    let query = `?page=${page}`;
    if (fromDate) query += `&from_date=${fromDate}`;
    if (toDate) query += `&to_date=${toDate}`;

    fetch(`/api/word-game/leaderboard/${query}`, {
        method: "GET",
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(data => {
        const tableHead = document.getElementById("tableHead");
        const tableBody = document.getElementById("tableBody");
        const prevBtn = document.getElementById("prevPage");
        const nextBtn = document.getElementById("nextPage");

        if (!data.results || Object.keys(data.results).length === 0) {
            tableBody.innerHTML = `<tr><td colspan="10" class="text-center">No data found.</td></tr>`;
            tableHead.innerHTML = `<tr><th>Rank</th><th>Username</th></tr>`;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }

        // DRF pagination wraps your object inside data.results
        const payload = data.results;
        const puzzleTitles = payload.puzzle_titles || [];
        const players = payload.results || [];

        // Build table header
        let headHtml = "<tr><th>Rank</th><th>Username</th>";
        puzzleTitles.forEach(title => headHtml += `<th>${title}</th>`);
        headHtml += "<th>Total Score</th></tr>";
        tableHead.innerHTML = headHtml;

        // Build table body
        tableBody.innerHTML = "";
        players.forEach(player => {
            let rowHtml = `<tr><td>${player.rank}</td><td>${player.username}</td>`;
            puzzleTitles.forEach(title => {
                rowHtml += `<td>${player[title] || 0}</td>`;
            });
            rowHtml += `<td>${player.total_score}</td></tr>`;
            tableBody.innerHTML += rowHtml;
        });

        // Pagination buttons
        prevBtn.disabled = !data.previous;
        nextBtn.disabled = !data.next;

        prevBtn.onclick = () => { currentPage--; fetchLeaderboard(currentPage); }
        nextBtn.onclick = () => { currentPage++; fetchLeaderboard(currentPage); }

    })
    .catch(err => {
        console.error("Error fetching leaderboard:", err);
        tableBody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error loading data.</td></tr>`;
    });
}
</script>
{% endblock %}
