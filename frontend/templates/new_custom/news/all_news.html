{% extends 'new_custom/new_templates/index2.html' %}
{% block title %}চাকরি নিউজ{% endblock %}

{% block style %}
<style>
/* (Your existing CSS remains here, ensuring the list layout is consistent) */

/* 1. Main Content Layout for Desktop */
.page-layout {
    display: flex;
    justify-content: center;
    gap: 20px; /* Space between main content and ads */
    padding: 20px 0;
}

/* 2. Ad Containers Styling (Hidden by default on small screens) */
.side-ad {
    width: 160px; /* Standard wide skyscraper width */
    flex-shrink: 0; /* Prevents the ad from shrinking */
    display: none; /* Hide on mobile by default */
}

/* 3. Media Query to Show Ads on Large Screens (e.g., above 992px) */
@media (min-width: 992px) {
    .side-ad {
        display: block; /* Show ads on large screens */
    }

    /* Adjust the main content width for better balance */
    .main-content {
        max-width: 750px;
        width: 100%;
    }
}

/* Center the news container within the main content */
.news-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 70vh;
}

/* List container */
.news-list {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
    max-width: 700px;
}

/* List items */
.news-item {
    border-bottom: 1px solid #e5e7eb;
    padding: 1rem 0;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.news-item:last-child {
    border-bottom: none;
}

/* Thumbnail image */
.news-thumb {
    width: 120px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
}

/* Title and meta container */
.news-content {
    flex: 1;
}

.news-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #231651;
    text-decoration: none;
    margin-bottom: 0.25rem;
    display: block;
}

.news-title:hover {
    color: #ff4b4b;
}

.news-meta {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

/* Read more link */
.btn-custom {
    display: inline-block;
    background-color: #ff4b4b;
    color: #fff;
    border: none;
    padding: 4px 12px;
    border-radius: 25px;
    font-size: 0.8rem;
    font-weight: 600;
    text-decoration: none;
    transition: background-color 0.3s ease;
}

.btn-custom:hover {
    background-color: #e64242;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .news-item {
        flex-direction: column;
        align-items: flex-start;
    }
    .news-thumb {
        width: 100%;
        height: 180px;
    }
}
</style>
{% endblock %}

{% block content %}
<main class="container py-5">

    <div class="text-center mb-5">
        <h1 id="category-header" class="fw-bold text-primary">সংবাদ</h1>
        <p class="lead text-muted">চাকরি, শিক্ষা, এবং অন্যান্য গুরুত্বপূর্ণ খবর</p>
    </div>

    <div class="page-layout">
        
        <div class="main-content">
            <div class="news-container">
                <div id="loading-message" class="text-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">সংবাদ লোড হচ্ছে...</p>
                </div>

                <ul id="news-list" class="news-list"></ul>

                <div id="no-news-message" class="text-center d-none my-5">
                    <p class="lead text-muted">এই ক্যাটাগরিতে কোনো সংবাদ পাওয়া যায়নি।</p>
                </div>

                <div id="error-message" class="text-center d-none my-5">
                    <p class="lead text-danger">সংবাদ লোড করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।</p>
                </div>
            </div>

            <nav aria-label="Page navigation" class="mt-5 d-flex justify-content-center">
                <ul class="pagination"></ul>
            </nav>
        </div>

        </div>
</main>
{% endblock %}


{% block body_js %}
<script>
document.addEventListener("DOMContentLoaded", async function() {
    const newsList = document.getElementById('news-list');
    const paginationContainer = document.querySelector('.pagination');
    const loadingMessage = document.getElementById('loading-message');
    const noNewsMessage = document.getElementById('no-news-message');
    const errorMessage = document.getElementById('error-message');
    const categoryHeader = document.getElementById('category-header');
    
    let currentPage = 1;
    const itemsPerPage = 9; // Should match DRF pagination setting
    let categoryId = null; 

    // 1. Function to extract category ID from URL (e.g., /news/5/)
    function getCategoryIdFromUrl() {
        // Regex to find the ID after '/news/' and before the next '/' or end of string
        const match = window.location.pathname.match(/\/news\/(\d+)\/?/);
        return match ? match[1] : null;
    }

    // 2. Function to fetch and update the category header name
    async function updateCategoryHeader(id) {
        if (!id) return;
        try {
            const response = await fetch(`/api/news-categories/${id}/`); // Assuming a retrieve endpoint exists
            if (!response.ok) throw new Error('Category fetch failed');
            
            const category = await response.json();
            categoryHeader.textContent = category.name + ' - চাকরির খবর';
            document.title = category.name + ' | চাকরি নিউজ';
        } catch (error) {
            console.warn('Could not fetch category name:', error);
            categoryHeader.textContent = 'ক্যাটাগরি খবর'; // Fallback
        }
    }

    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const date = new Date(dateString);
        return date.toLocaleDateString('bn-BD', options);
    }

    function renderNewsItems(newsListData) {
        newsList.innerHTML = '';
        if (newsListData.length > 0) {
            newsListData.forEach(news => {
                const imageUrl = news.images?.length > 0
                    ? news.images[0].image_url
                    : 'https://via.placeholder.com/120x80.png?text=No+Image';
                const newsItem = document.createElement('li');
                newsItem.className = 'news-item';
                newsItem.innerHTML = `
                    <img src="${imageUrl}" alt="${news.title}" class="news-thumb">
                    <div class="news-content">
                        <a href="/news/details/${news.id}" class="news-title">${news.title}</a>
                        <p class="news-meta"><i class="fa-solid fa-calendar-alt"></i> ${formatDate(news.published_date)}</p>
                        <a href="/news/details/${news.id}" class="btn-custom">বিস্তারিত পড়ুন</a>
                    </div>
                `;
                newsList.appendChild(newsItem);
            });
            noNewsMessage.classList.add('d-none');
        } else {
            noNewsMessage.classList.remove('d-none');
        }
    }

    function renderPagination(count, next, previous) {
        paginationContainer.innerHTML = '';

        const totalPages = Math.ceil(count / itemsPerPage);
        if (totalPages <= 1) return;

        // ... (Pagination logic is unchanged, remains correct) ...
        
        // Previous button
        const prevItem = document.createElement('li');
        prevItem.className = `page-item ${!previous ? 'disabled' : ''}`;
        prevItem.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">পূর্ববর্তী</a>`;
        paginationContainer.appendChild(prevItem);

        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        // Adjust visible range if near edges
        if (currentPage <= 3) endPage = Math.min(totalPages, 5);
        if (currentPage > totalPages - 2) startPage = Math.max(1, totalPages - 4);


        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            paginationContainer.appendChild(pageItem);
        }

        // Next button
        const nextItem = document.createElement('li');
        nextItem.className = `page-item ${!next ? 'disabled' : ''}`;
        nextItem.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">পরবর্তী</a>`;
        paginationContainer.appendChild(nextItem);

        // Add click handlers
        paginationContainer.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const newPage = parseInt(this.getAttribute('data-page'));
                if (newPage >= 1 && newPage <= totalPages && newPage !== currentPage) {
                    currentPage = newPage;
                    fetchAndRenderNews(currentPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top on page change
                }
            });
        });
    }

    async function fetchAndRenderNews(page = 1) {
        loadingMessage.classList.remove('d-none');
        noNewsMessage.classList.add('d-none');
        errorMessage.classList.add('d-none');

        // Construct the API URL with category filter
        let apiUrl = `/api/news/?page=${page}`;
        if (categoryId) {
            // This assumes your backend has implemented the category_id filtering
            apiUrl += `&category_id=${categoryId}`;
        }

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            loadingMessage.classList.add('d-none');

            // Set itemsPerPage dynamically based on backend pagination size if necessary
            // For now, keep it hardcoded to 9 (as per your current JS)
            
            renderNewsItems(data.results);
            renderPagination(data.count, data.next, data.previous);
        } catch (error) {
            console.error('Error fetching news:', error);
            loadingMessage.classList.add('d-none');
            errorMessage.classList.remove('d-none');
        }
    }

    // --- Initial setup ---
    categoryId = getCategoryIdFromUrl();
    
    if (categoryId) {
        updateCategoryHeader(categoryId);
    } else {
        categoryHeader.textContent = 'সকল খবর'; // Fallback if no ID is found in URL
    }
    
    // Initial load
    fetchAndRenderNews(currentPage);
});
</script>
{% endblock %}