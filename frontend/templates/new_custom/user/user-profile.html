{% extends 'new_custom/new_templates/index2.html' %}
{% load static %}

{% block head_link %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.2);
        --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        --accent-color: #6366f1;
    }

    body {
        background: #f8fafc;
        font-family: 'Inter', sans-serif;
        color: #1e293b;
    }

    .container { max-width: 1100px; }

    /* Profile Hero Section */
    .profile-hero {
        background: var(--primary-gradient);
        border-radius: 24px;
        padding: 40px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }

    .profile-hero::after {
        content: "";
        position: absolute;
        top: -10%; right: -5%;
        width: 300px; height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }

    .avatar-wrapper {
        width: 100px;
        height: 100px;
        background: white;
        color: var(--accent-color);
        font-size: 2.5rem;
        font-weight: 700;
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin: 0 auto;
    }

    /* Stats Cards */
    .stat-pill {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 20px;
        padding: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-pill:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }

    .stat-pill small {
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        color: #64748b;
    }

    .stat-pill h4 {
        margin-top: 5px;
        font-weight: 700;
        color: #0f172a;
    }

    /* Glass Cards */
    .glass-card {
        background: white;
        border-radius: 24px;
        padding: 25px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .glass-card h5 {
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* List styling */
    .custom-list-item {
        border: none !important;
        border-bottom: 1px solid #f1f5f9 !important;
        padding: 15px 10px;
    }

    .custom-list-item:last-child { border-bottom: none !important; }

    .badge-soft {
        background: #eef2ff;
        color: #4338ca;
        padding: 6px 12px;
        border-radius: 10px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">

    <div class="profile-hero">
        <div class="row align-items-center">
            <div class="col-lg-2 text-center text-lg-start">
                <div class="avatar-wrapper" id="user-avatar">?</div>
            </div>
            <div class="col-lg-6 text-center text-lg-start mt-3 mt-lg-0">
                <h2 class="fw-bold mb-1" id="display-name">Guest User</h2>
                <p class="opacity-75 mb-2" id="display-phone"><i class="fa-solid fa-phone me-2"></i>01xxxxxxxxx</p>
                <div class="d-flex justify-content-center justify-content-lg-start gap-2">
                    <span class="badge rounded-pill bg-white text-dark px-3 py-2">
                        <i class="fa-solid fa-trophy text-warning me-1"></i> Rank #<span id="practice-rank-badge">-</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-6 col-md-3">
            <div class="stat-pill">
                <small><i class="fa-solid fa-star text-warning me-1"></i> Points</small>
                <h4 id="stat-points">0</h4>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-pill">
                <small><i class="fa-solid fa-wallet text-success me-1"></i> Earnings</small>
                <h4>à§³ <span id="stat-rewards">0</span></h4>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-pill">
                <small><i class="fa-solid fa-chart-line text-primary me-1"></i> Rank</small>
                <h4>#<span id="practice-rank">-</span></h4>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="stat-pill">
                <small><i class="fa-solid fa-gamepad text-info me-1"></i> Games</small>
                <h4 id="total-games">0</h4>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="glass-card h-100">
                <h5><i class="fa-solid fa-bolt text-primary"></i> Practice Activity</h5>
                <div style="height:320px">
                    <canvas id="practiceChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="glass-card h-100">
                <h5><i class="fa-solid fa-ranking-star text-primary"></i> Recent Puzzles</h5>
                <div class="list-group list-group-flush" id="game-score-list">
                    </div>
                <div class="mt-4">
                    <canvas id="gameChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block body_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const token = localStorage.getItem('access_token');
    const phone = localStorage.getItem('phone_number');

    let apiUrl = '/api/v1/game-activity/';
    let headers = { 'Content-Type': 'application/json' };

    if (token) headers['Authorization'] = `Bearer ${token}`;
    else if (phone) apiUrl += `?phone=${phone}`;

    fetch(apiUrl, { headers })
        .then(res => res.json())
        .then(data => {
            renderProfile(data);
            renderPracticeChart(data.history.practice);
            renderGamePerformance(data.history.puzzles);
        });
});

function renderProfile(data) {
    document.getElementById('display-phone').innerText = data.identity.phone_number;
    document.getElementById('display-name').innerText = data.identity.username || 'Guest';
    document.getElementById('user-avatar').innerText = (data.identity.username || data.identity.phone_number)[0].toUpperCase();
    document.getElementById('practice-rank').innerText = data.stats.quiz_rank || '-';
    document.getElementById('practice-rank-badge').innerText = data.stats.quiz_rank || '-';
    document.getElementById('stat-points').innerText = data.stats.current_points.toLocaleString();
    document.getElementById('stat-rewards').innerText = data.stats.total_rewards_taka;
    document.getElementById('total-games').innerText = data.history.puzzles.length;
}

function renderPracticeChart(practice) {
    const ctx = document.getElementById('practiceChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
    gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: practice.map((_, i) => `S${i + 1}`),
            datasets: [{
                label: 'Score',
                data: practice.map(p => p.score),
                borderColor: '#6366f1',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                backgroundColor: gradient,
                pointBackgroundColor: '#6366f1',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { display: false }, border: { display: false } },
                x: { grid: { display: false }, border: { display: false } }
            }
        }
    });
}

function renderGamePerformance(puzzles) {
    if (!puzzles.length) return;

    const list = document.getElementById('game-score-list');
    list.innerHTML = puzzles.slice(0, 4).map(g => `
        <div class="custom-list-item d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-bold text-dark">${g.puzzle__title}</div>
                <small class="text-muted">Puzzle Game</small>
            </div>
            <span class="badge-soft">${g.total_puzzle_score} pts</span>
        </div>
    `).join('');

    const ctx = document.getElementById('gameChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: puzzles.map(g => g.puzzle__title.split(' ')[0]),
            datasets: [{
                data: puzzles.map(g => g.total_puzzle_score),
                backgroundColor: '#6366f1',
                borderRadius: 8,
                barThickness: 15
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                y: { display: false },
                x: { grid: { display: false } }
            }
        }
    });
}
</script>
{% endblock %}