{% extends "new_custom/new_templates/index2.html" %}

{% block content %}
<div class="container my-5" id="notice-detail-container">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div id="loading-state" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">লোড হচ্ছে...</span>
                </div>
                <p class="mt-3 text-muted">আনুষ্ঠানিক বিজ্ঞপ্তির বিস্তারিত তথ্য আনা হচ্ছে...</p>
            </div>
            
            <div id="notice-content" style="display: none;"></div>
            
        </div>
    </div>
</div>
{% endblock %}

---

{% block body_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const loadingState = document.getElementById("loading-state");
    const noticeContent = document.getElementById("notice-content");

    // FIX 1: Simplify URL extraction to reduce complexity.
    // Assumes URL structure is /notices/ID/ or /notices/ID/slug/
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    // Looking for the ID, often the second-to-last segment if there's a trailing slash, or the last if there's no slug.
    const noticeId = pathParts[pathParts.length - 2]; 

    // Helper function to format dates professionally in Bengali locale
    const formatDate = (dateString) => {
        if (!dateString) return 'প্রযোজ্য নয়';
        return new Date(dateString).toLocaleDateString('bn-BD', { 
            year: 'numeric', month: 'long', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });
    };

    function renderError(message) {
        loadingState.style.display = 'none';
        noticeContent.innerHTML = `
            <div class="alert alert-danger text-center shadow-sm" role="alert">
                <i class="bi bi-x-octagon-fill me-2"></i>
                <strong>ত্রুটি:</strong> ${message}
                <a href="javascript:history.back()" class="alert-link ms-3">ফিরে যান</a>
            </div>
        `;
        noticeContent.style.display = 'block';
    }

    async function fetchNotice() {
        if (!noticeId || isNaN(noticeId)) {
             return renderError("URL-এ বিজ্ঞপ্তির আইডিটি সঠিক নয়।");
        }

        try {
            // FIX 2: Revert fetch to standard string concatenation for stability.
            const apiUrl = '/api/notices/' + noticeId + '/';
            const response = await fetch(apiUrl);
            
            if (response.status === 404) {
                return renderError("অনুরোধ করা বিজ্ঞপ্তিটি খুঁজে পাওয়া যায়নি।");
            }
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }

            const notice = await response.json();
            
            loadingState.style.display = 'none';

            // --- Notice Card Rendering (Uses template literals for clean HTML) ---
            noticeContent.innerHTML = `
                <div class="card shadow-lg border-0 mb-4">
                    <div class="card-header bg-primary text-white p-3 rounded-top">
                        <h1 class="h4 mb-0 fw-bold">
                            <i class="bi bi-megaphone-fill me-2"></i> ${notice.title}
                        </h1>
                    </div>
                    <div class="card-body p-4 p-md-5">
                        
                        <div class="d-flex flex-wrap gap-2 mb-4">
                            <span class="badge text-bg-info text-dark">
                                <i class="bi bi-calendar-plus me-1"></i> প্রকাশিত: ${formatDate(notice.created_at)}
                            </span>
                            ${notice.government_job ? `
                            <!-- <span class="badge text-bg-light border text-dark">
                                <i class="bi bi-building me-1"></i> চাকরির ধরন: ${notice.government_job}
                            </span>` : ''} -->
                            ${notice.updated_at && notice.created_at !== notice.updated_at ? `
                                <!-- <span class="badge text-bg-warning text-dark">
                                    <i class="bi bi-pencil-square me-1"></i> সর্বশেষ আপডেট: ${formatDate(notice.updated_at)}
                                </span>` : ''} -->
                        </div>

                        <div class="notice-description mb-4 pb-3 border-bottom">
                            <h5 class="fw-semibold text-dark">বিস্তারিত:</h5>
                            <p class="card-text text-secondary lead">
                                ${notice.description || "<em>এই বিজ্ঞপ্তির জন্য কোনো বিস্তারিত বিবরণ সরবরাহ করা হয়নি। অনুগ্রহ করে অফিশিয়াল লিঙ্ক বা সংযুক্ত পিডিএফ দেখুন।</em>"}
                            </p>
                        </div>

                        <div class="d-flex flex-wrap gap-3 pt-2">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary d-inline-flex align-items-center">
                                <i class="bi bi-arrow-left-short me-2"></i> ফিরে যান
                            </a>
                            
                            ${notice.pdf ? `
                                <a href="${notice.pdf}" target="_blank" class="btn btn-danger d-inline-flex align-items-center shadow-sm">
                                    <i class="bi bi-file-earmark-pdf-fill me-2"></i> পিডিএফ দেখুন
                                </a>` : ""}
                                
                            ${notice.link ? `
                                <a href="${notice.link}" target="_blank" class="btn btn-success d-inline-flex align-items-center shadow-sm">
                                    <i class="bi bi-box-arrow-up-right me-2"></i> অফিশিয়াল লিঙ্ক
                                </a>` : ""}
                        </div>
                    </div>
                </div>
            `;
            noticeContent.style.display = 'block';

        } catch (error) {
            renderError("অনুরোধ প্রক্রিয়াকরণের সময় একটি অপ্রত্যাশিত ত্রুটি ঘটেছে।");
            console.error("Fetch Error:", error);
        }
    }

    fetchNotice();
});
</script>
{% endblock %}